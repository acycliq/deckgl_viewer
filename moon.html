<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Tile Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Deck.gl and dependencies -->
    <script src="https://unpkg.com/@deck.gl/core@8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/layers@8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/geo-layers@8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.0/dist.min.js"></script>

    <script>
        // Wait for deck.gl to load
        if (typeof deck === 'undefined') {
            console.error('deck.gl failed to load');
        }

        const {DeckGL, OrthographicView, COORDINATE_SYSTEM, TileLayer, BitmapLayer} = deck;

        const INITIAL_VIEW_STATE = {
            target: [13000, 13000, 0],
            zoom: -7
        };

        const ROOT_URL = 'https://raw.githubusercontent.com/visgl/deck.gl-data/master/website/image-tiles/moon.image';

        // State variables
        let dimensions = null;
        let deckglInstance = null;
        let autoHighlight = true;

        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function getTooltip({tile, bitmap}) {
            if (tile && bitmap) {
                const {x, y, z} = tile.index;
                return `tile: x: ${x}, y: ${y}, z: ${z}
(${bitmap.pixel[0]},${bitmap.pixel[1]}) in ${bitmap.size.width}x${bitmap.size.height}`;
            }
            return null;
        }

        async function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        async function getMetaData() {
            try {
                const dziSource = `${ROOT_URL}/moon.image.dzi`;
                const response = await fetch(dziSource);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const dziXML = parser.parseFromString(xmlText, 'text/xml');

                const imageElement = dziXML.getElementsByTagName('Image')[0];
                const sizeElement = dziXML.getElementsByTagName('Size')[0];

                if (Number(imageElement.attributes.Overlap.value) !== 0) {
                    console.warn('Overlap parameter is nonzero and should be 0');
                }

                dimensions = {
                    height: Number(sizeElement.attributes.Height.value),
                    width: Number(sizeElement.attributes.Width.value),
                    tileSize: Number(imageElement.attributes.TileSize.value)
                };

                // Initialize deck.gl after getting dimensions
                initializeDeckGL();
            } catch (error) {
                console.error('Error loading metadata:', error);
            }
        }

        function createTileLayer() {
            if (!dimensions) return null;

            return new TileLayer({
                id: 'tile-layer',
                pickable: autoHighlight,
                tileSize: dimensions.tileSize,
                autoHighlight,
                highlightColor: [60, 60, 60, 100],
                minZoom: -7,
                maxZoom: 0,
                coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
                extent: [0, 0, dimensions.width, dimensions.height],
                getTileData: async ({index}) => {
                    const {x, y, z} = index;
                    const imageUrl = `${ROOT_URL}/moon.image_files/${15 + z}/${x}_${y}.jpeg`;
                    try {
                        return await loadImage(imageUrl);
                    } catch (error) {
                        console.error('Error loading tile:', imageUrl, error);
                        return null;
                    }
                },
                onViewportLoad: (tiles) => {
                    // Callback for when tiles are loaded
                    console.log('Tiles loaded:', tiles.length);
                },
                renderSubLayers: (props) => {
                    if (!props.data) return null;

                    const {
                        bbox: {left, bottom, right, top}
                    } = props.tile;
                    const {width, height} = dimensions;

                    return new BitmapLayer({
                        ...props,
                        id: `${props.id}-bitmap`,
                        data: null,
                        image: props.data,
                        bounds: [
                            clamp(left, 0, width),
                            clamp(bottom, 0, height),
                            clamp(right, 0, width),
                            clamp(top, 0, height)
                        ]
                    });
                }
            });
        }

        function initializeDeckGL() {
            const container = document.getElementById('map');

            deckglInstance = new DeckGL({
                container,
                views: [new OrthographicView({id: 'ortho'})],
                initialViewState: INITIAL_VIEW_STATE,
                controller: true,
                getTooltip: getTooltip,
                layers: [createTileLayer()].filter(Boolean)
            });
        }

        function updateLayers() {
            if (deckglInstance && dimensions) {
                deckglInstance.setProps({
                    layers: [createTileLayer()]
                });
            }
        }

        // Initialize the application
        async function init() {
            await getMetaData();
        }

        // Start the application when the page loads
        window.addEventListener('load', () => {
            // Check if deck.gl loaded properly
            if (typeof deck !== 'undefined') {
                init();
            } else {
                console.error('deck.gl library not available');
            }
        });
    </script>
</body>
</html>