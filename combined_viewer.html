<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Gene Expression and Cell Boundary Viewer</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/deck.gl@8.8.27/dist.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-dsv@3"></script>
    <script src="https://unpkg.com/d3-array@3"></script>
    <!-- Import the polygon boundary highlighter -->
    <script src="modules/polygon-boundary-highlighter.js"></script>
    <!-- Import glyph helpers -->
    <script src="modules/glyphPaths.js"></script>
    <script src="modules/glyphConfig.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="tooltip"></div>

    <!-- Gene Panel Button -->
    <button id="genePanelBtn">Gene Panel</button>

    <!-- Main Controls -->
    <div class="main-controls">
        <button class="nav-btn" id="prevBtn">◄</button>
        <input type="range" id="planeSlider" min="0" max="99" value="50">
        <button class="nav-btn" id="nextBtn">►</button>
        <span id="planeLabel">Plane: 50</span>
    </div>

    <!-- Layer Controls -->
    <div class="layer-controls" id="layerControls">
        <button class="minimize-btn" id="minimizeBtn">−</button>
        <h3>Display Layers</h3>

        <div class="control-section">
            <h4>Main Layers</h4>
            <div class="layer-toggle">
                <input type="checkbox" id="showTiles" checked>
                <label for="showTiles">Background Images</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="showPolygons" checked>
                <label for="showPolygons">Cell Boundaries</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="showGenes" checked>
                <label for="showGenes">Gene Expression</label>
            </div>
        </div>

        <div class="control-section">
            <h4>Polygon Groups</h4>
            <button class="toggle-btn secondary" id="toggleAllPolygons">Toggle All Groups</button>
            <div id="polygonAliasControls">
                <!-- Dynamically populated -->
            </div>
        </div>

        <div class="control-section gene-controls">
            <h4>Gene Display</h4>
            <div class="gene-size-control">
                <label for="geneSizeSlider">Gene Size: <span id="geneSizeValue">1.0</span></label>
                <input type="range" id="geneSizeSlider" min="0.5" max="3.0" step="0.1" value="1.0">
            </div>
            <button class="toggle-btn secondary" id="toggleAllGenes">Toggle All Genes</button>
        </div>
    </div>

    <div class="loading-indicator" id="loadingIndicator">Loading...</div>

    <script type="module">
        // Import configuration constants
        import {
            TILE_BASE_URL,
            INITIAL_VIEW_STATE,
            MAX_PRELOAD,
            DEFAULT_STATE,
            UI_ELEMENTS
        } from './config/constants.js';

        // Import coordinate transformation utilities
        import {
            clamp
        } from './utils/coordinateTransform.js';

        // Import data loading functions
        import {
            loadGeneData,
            loadPolygonData,
            assignColorsToPolygonAliases
        } from './modules/dataLoaders.js';

        // Import layer creation functions
        import {
            createTileLayer,
            createPolygonLayers,
            createGeneLayers
        } from './modules/layerCreators.js';

        // Import UI helper functions
        import {
            showLoading,
            hideLoading,
            showTooltip,
            updatePolygonAliasControls
        } from './modules/uiHelpers.js';

        // Import event handling functions
        import {
            setupEventHandlers
        } from './modules/eventHandlers.js';

        // Extract deck.gl components
        const {DeckGL, OrthographicView, COORDINATE_SYSTEM} = deck;

        // Application state
        const state = {
            currentPlane: DEFAULT_STATE.currentPlane,
            deckglInstance: null,
            isLoading: false,
            
            // Layer visibility
            showTiles: DEFAULT_STATE.showTiles,
            showPolygons: DEFAULT_STATE.showPolygons,
            showGenes: DEFAULT_STATE.showGenes,
            
            // Data caches
            tileCache: new Map(),
            polygonCache: new Map(),
            geneDataMap: new Map(),
            
            // Polygon data
            polygonAliasVisibility: new Map(),
            polygonAliasColors: new Map(),
            allPolygonAliases: new Set(),
            
            // Gene data
            selectedGenes: new Set(),
            geneIconAtlas: null,
            geneIconMapping: null,
            geneSizeScale: DEFAULT_STATE.geneSizeScale,
            
            // Interactions
            polygonHighlighter: null,
            genePanelWin: null
        };

        // DOM elements
        const elements = {
            slider: document.getElementById(UI_ELEMENTS.planeSlider),
            label: document.getElementById(UI_ELEMENTS.planeLabel),
            prevBtn: document.getElementById(UI_ELEMENTS.prevBtn),
            nextBtn: document.getElementById(UI_ELEMENTS.nextBtn),
            loadingIndicator: document.getElementById(UI_ELEMENTS.loadingIndicator),
            
            // Layer controls
            showTiles: document.getElementById(UI_ELEMENTS.showTiles),
            showPolygons: document.getElementById(UI_ELEMENTS.showPolygons),
            showGenes: document.getElementById(UI_ELEMENTS.showGenes),
            
            // Polygon controls
            toggleAllPolygons: document.getElementById(UI_ELEMENTS.toggleAllPolygons),
            polygonAliasControls: document.getElementById(UI_ELEMENTS.polygonAliasControls),
            
            // Gene controls
            geneSizeSlider: document.getElementById(UI_ELEMENTS.geneSizeSlider),
            geneSizeValue: document.getElementById(UI_ELEMENTS.geneSizeValue),
            toggleAllGenes: document.getElementById(UI_ELEMENTS.toggleAllGenes),
            genePanelBtn: document.getElementById(UI_ELEMENTS.genePanelBtn),
            
            // UI
            layerControls: document.getElementById(UI_ELEMENTS.layerControls),
            minimizeBtn: document.getElementById(UI_ELEMENTS.minimizeBtn),
            tooltip: document.getElementById(UI_ELEMENTS.tooltip)
        };

        // === UTILITY FUNCTIONS ===
        // Utility functions have been moved to modules/uiHelpers.js and modules/dataLoaders.js


        // === GENE DATA FUNCTIONS ===
        // Gene data loading functions have been moved to modules/dataLoaders.js

        // === POLYGON DATA FUNCTIONS ===
        // Polygon data loading functions have been moved to modules/dataLoaders.js

        // === LAYER CREATION FUNCTIONS ===
        // Layer creation functions have been moved to modules/layerCreators.js

        // === MAIN UPDATE FUNCTION ===
        function updateAllLayers() {
            if (!state.deckglInstance) return;

            const layers = [];

            // Add tile layers
            const direction = elements.slider.value > state.currentPlane ? 1 : -1;
            const preloadAhead = direction === 1 ? MAX_PRELOAD + 1 : MAX_PRELOAD;
            const preloadBehind = direction === -1 ? MAX_PRELOAD + 1 : MAX_PRELOAD;

            const start = Math.max(0, state.currentPlane - preloadBehind);
            const end = Math.min(99, state.currentPlane + preloadAhead);

            for (let plane = start; plane <= end; plane++) {
                const opacity = plane === state.currentPlane ? 1 : 0;
                layers.push(createTileLayer(plane, opacity, state.tileCache, TILE_BASE_URL, state.showTiles));
            }

            // Add polygon layers for current plane
            layers.push(...createPolygonLayers(state.currentPlane, state.polygonCache, state.showPolygons, state.polygonAliasVisibility, state.polygonAliasColors));

            // Add gene layers
            layers.push(...createGeneLayers(state.geneDataMap, state.showGenes, state.selectedGenes, state.geneIconAtlas, state.geneIconMapping, state.currentPlane, state.geneSizeScale, (info) => showTooltip(info, elements.tooltip)));

            state.deckglInstance.setProps({ layers: layers });
        }

        // === MAIN PLANE UPDATE FUNCTION ===
        async function updatePlane(newPlane) {
            if (state.isLoading) return;

            showLoading(state, elements.loadingIndicator);

            state.currentPlane = clamp(newPlane, 0, 99);
            elements.slider.value = state.currentPlane;
            elements.label.textContent = `Plane: ${state.currentPlane}`;

            // Load polygon data for current plane
            console.log(`updatePlane: About to load polygon data for plane ${state.currentPlane}`);
            const polygonResult = await loadPolygonData(state.currentPlane, state.polygonCache, state.allPolygonAliases);
            console.log(`updatePlane: loadPolygonData returned:`, polygonResult);
            
            // Update polygon controls after loading new data
            assignColorsToPolygonAliases(state.allPolygonAliases, state.polygonAliasColors, state.polygonAliasVisibility);
            updatePolygonAliasControls(state.allPolygonAliases, state.polygonAliasVisibility, state.polygonAliasColors, elements.polygonAliasControls, updateAllLayers);

            // Preload adjacent polygon data
            if (state.currentPlane > 0) {
                loadPolygonData(state.currentPlane - 1, state.polygonCache, state.allPolygonAliases).catch(() => {});
            }
            if (state.currentPlane < 99) {
                loadPolygonData(state.currentPlane + 1, state.polygonCache, state.allPolygonAliases).catch(() => {});
            }

            // Update layers after loading polygon data
            updateAllLayers();
            
            hideLoading(state, elements.loadingIndicator);
        }

        // === TOOLTIP FUNCTIONS ===
        // Tooltip functions have been moved to modules/uiHelpers.js

        // === DECK.GL INITIALIZATION ===
        function initializeDeckGL() {
            state.deckglInstance = new DeckGL({
                container: 'map',
                views: [new OrthographicView({id: 'ortho'})],
                initialViewState: INITIAL_VIEW_STATE,
                controller: {
                    minZoom: 0,
                    maxZoom: 8,
                    scrollZoom: true,
                    doubleClickZoom: true,
                    touchZoom: true,
                    keyboard: true
                },
                onHover: (info) => showTooltip(info, elements.tooltip),
                getCursor: ({isHovering}) => (isHovering ? 'pointer' : 'default'),
                layers: []
            });

            // Initialize polygon highlighter
            state.polygonHighlighter = new PolygonBoundaryHighlighter(
                state.deckglInstance,
                COORDINATE_SYSTEM.CARTESIAN
            );
            state.polygonHighlighter.initialize();
        }

        // === EVENT HANDLERS ===
        // Event handling functions have been moved to modules/eventHandlers.js

        // === MAIN INITIALIZATION ===
        async function init() {
            showLoading(state, elements.loadingIndicator);
            
            // Clear polygon cache to ensure fresh load on app restart
            state.polygonCache.clear();
            
            // Initialize deck.gl instance and create the map container
            initializeDeckGL();
            
            // Setup all UI event listeners (slider, buttons, toggles, etc.)
            setupEventHandlers(elements, state, updatePlane, updateAllLayers);
            
            // Load gene data first - this builds the gene icon atlas and populates geneDataMap
            // Gene data is shared across all planes, so we only need to load it once
            const {atlas, mapping} = await loadGeneData(state.geneDataMap, state.selectedGenes);
            state.geneIconAtlas = atlas;
            state.geneIconMapping = mapping;
            
            // CRITICAL FIX: Explicitly load polygon data for current plane before updating layers
            // Previous bug: updateAllLayers() was called before polygon data was loaded,
            // causing polygons to be missing on initial page load (race condition)
            // This ensures polygon data is cached before any rendering happens
            console.log(`Init: Loading polygon data for plane ${state.currentPlane}`);
            const polygonResult = await loadPolygonData(state.currentPlane, state.polygonCache, state.allPolygonAliases);
            console.log(`Init: Polygon data loaded:`, polygonResult);
            
            // Assign colors and update controls after loading polygon data
            assignColorsToPolygonAliases(state.allPolygonAliases, state.polygonAliasColors, state.polygonAliasVisibility);
            updatePolygonAliasControls(state.allPolygonAliases, state.polygonAliasVisibility, state.polygonAliasColors, elements.polygonAliasControls, updateAllLayers);
            
            // Update UI to reflect the current plane state after data loading
            state.currentPlane = DEFAULT_STATE.currentPlane;
            elements.slider.value = state.currentPlane;
            elements.label.textContent = `Plane: ${state.currentPlane}`;
            
            // Now safely update all layers - all required data (genes, polygons) is loaded
            // This will render: background tiles + gene markers + cell boundary polygons
            updateAllLayers();
            
            hideLoading(state, elements.loadingIndicator);
        }

        // Start the application
        window.addEventListener('load', init);
    </script>
</body>
</html>