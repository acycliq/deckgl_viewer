<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>deck.gl Gene TSV viewer</title>
  <style>
    html, body { margin:0; height:100%; font-family: Arial,Helvetica,sans-serif; }
    #root { position: relative; width:100%; height:100%; }
    #deck-canvas { position:absolute; top:0; left:0; right:0; bottom:48px; }
    #controls { position:absolute; left:0; right:0; bottom:0; height:48px;
      display:flex; align-items:center; padding:4px 8px; background:#fafafa;
      border-top:1px solid #ccc; box-shadow:0 -2px 4px rgba(0,0,0,0.1); gap:12px; }
    #planeValue, #thicknessValue { width:32px; text-align:right; }
    input[type=range] { width:120px; }
  </style>
</head>
<body>
  <div id="root">
    <div id="deck-canvas"></div>
    <div id="controls">
      <label>Plane:</label>
      <span id="planeValue">0</span>
      <input id="planeSlider" type="range" min="0" max="0" step="1" value="0" />
      <label>Thickness:</label>
      <span id="thicknessValue">2</span>
      <input id="thicknessSlider" type="range" min="1" max="10" step="1" value="2" />
    </div>
  </div>

  <script src="glyphPaths.js"></script>
  <script src="glyphConfig.js"></script>
  <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
  <script src="https://unpkg.com/d3-dsv@3"></script>
  <script src="https://unpkg.com/d3-array@3"></script>

  <script>
    const settings = glyphSettings();
    const configMap = new Map(settings.map(s => [s.gene, {glyphName: s.glyphName, color: s.color}]));
    const defaultConfig = configMap.get('Generic') || {glyphName:'circle', color:'#000000'};

    function hexToRgba(hex) {
      const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      return m ? [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)] : [0,0,0];
    }

    let data = [];
    let genes = [];
    let plane = 0;
    let thickness = 2;
    let iconAtlas = null;
    let iconMapping = null;

    function buildAtlas(genesList, strokeWidth) {
      const size = 64;
      const canvas = document.createElement('canvas');
      canvas.width = size * genesList.length;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      const mapping = {};

      genesList.forEach((gene, i) => {
        const cfg = configMap.get(gene) || defaultConfig;
        const glyphName = cfg.glyphName;
        const color = cfg.color;
        const p = {x: i*size + size/2, y: size/2};
        const r = size * 0.4;
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = strokeWidth;
        ctxPath(glyphName, ctx, p, r);
        ctx.stroke();
        ctx.restore();

        mapping[gene] = {
          x: i*size, y: 0,
          width: size, height: size,
          anchorX: size/2, anchorY: size/2,
          mask: false
        };
      });

      return {atlas: canvas, mapping};
    }

    const {IconLayer, OrthographicView, COORDINATE_SYSTEM} = deck;
    const deckgl = new deck.Deck({
      parent: document.getElementById('deck-canvas'),
      views: new OrthographicView({controller:true}),
      initialViewState:{target:[0,0,0], zoom:0, minZoom:-5, maxZoom:10},
      controller:true,
      layers: []
    });

    function updateAtlasAndLayers() {
      const atlasObj = buildAtlas(genes, thickness);
      iconAtlas = atlasObj.atlas;
      iconMapping = atlasObj.mapping;
      deckgl.setProps({layers:[new IconLayer({
        id:'spots', data,
        coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
        iconAtlas, iconMapping,
        getPosition: d=>[d.x,-d.y],
        getSize: d=>20/Math.sqrt(1+Math.abs(d.z-plane)),
        sizeUnits:'pixels', sizeScale:1,
        getIcon: d=>d.gene,
        getColor:[255,255,255],
        updateTriggers:{getSize:[plane]}
      })]});
    }

    document.getElementById('planeSlider').addEventListener('input', e=>{
      plane = +e.target.value;
      document.getElementById('planeValue').textContent = plane;
      updateAtlasAndLayers();
    });

    document.getElementById('thicknessSlider').addEventListener('input', e=>{
      thickness = +e.target.value;
      document.getElementById('thicknessValue').textContent = thickness;
      updateAtlasAndLayers();
    });

    fetch('data/geneData.tsv')
      .then(r=>r.text())
      .then(txt=>{
        data = d3.tsvParse(txt, d=>({x:+d.x, y:+d.y, z:+d.plane_id, gene:d.gene_name}));
        genes = Array.from(new Set(data.map(d=>d.gene)));

        const zExt = d3.extent(data, d=>d.z);
        const planeSlider = document.getElementById('planeSlider');
        planeSlider.min=zExt[0]; planeSlider.max=zExt[1]; planeSlider.step=1;
        plane = planeSlider.value=zExt[0]; document.getElementById('planeValue').textContent=plane;

        const xExt = d3.extent(data,d=>d.x), yExt = d3.extent(data,d=>d.y);
        const cx=(xExt[0]+xExt[1])/2, cy=-(yExt[0]+yExt[1])/2;
        const w=deckgl.canvas.clientWidth, h=deckgl.canvas.clientHeight;
        const zoom=Math.min(Math.log2(w/(xExt[1]-xExt[0])), Math.log2(h/(yExt[1]-yExt[0])));
        deckgl.setProps({initialViewState:{target:[cx,cy,0], zoom, minZoom:-5, maxZoom:10}});

        updateAtlasAndLayers();
      })
      .catch(e=>console.error('Load error',e));
  </script>
</body>
</html>
