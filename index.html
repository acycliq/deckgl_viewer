<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>deck.gl Gene TSV viewer</title>
  <style>
    html, body {
      margin:0;
      height:100%;
      font-family: Arial,Helvetica,sans-serif;
    }
    #root {
      position: relative;
      width:100%;
      height:100%;
      background-color: #000;
      color: #fff;
    }
    #deck-canvas {
      position:absolute;
      top:0;
      left:220px;
      right:0;
      bottom:48px;
      background-color: #000;
      /* This CSS rule is no longer strictly necessary as JS will control the cursor, but it's fine as a fallback. */
      cursor: default;
    }
    #controls {
      position:absolute;
      left:220px;
      right:0;
      bottom:0;
      height:48px;
      display:flex;
      align-items:center;
      padding:4px 8px;
      background:rgba(0,0,0,0.8);
      border-top:1px solid #444;
      gap:8px;
    }
    #controls label, #controls span {
      color:#fff;
    }
    input[type=range] {
      flex:1;
      background:transparent;
    }
    #tooltip {
      position:absolute;
      pointer-events:none;
      background:rgba(0,0,0,0.75);
      color:#fff;
      padding:6px;
      border-radius:4px;
      font-size:12px;
      display:none;
      white-space:nowrap;
      z-index:1000;
    }
    /* Styling for the gene filter panel */
    #filter-panel {
      position:absolute;
      top:0;
      left:0;
      bottom:0;
      width:220px;
      background: #181818;
      color: #fff;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    #filter-panel h3 {
      margin: 0;
      padding: 12px;
      font-size: 16px;
      border-bottom: 1px solid #444;
    }
    #filter-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .filter-item {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .filter-item:hover {
      background: #333;
    }
    .filter-item input {
      margin-right: 8px;
    }
    .color-swatch {
      width: 12px;
      height: 12px;
      margin-right: 8px;
      border: 1px solid #666;
    }
  </style>
</head>
<body>
  <div id="root">
    <div id="filter-panel">
      <h3>Genes</h3>
      <div id="filter-list"></div>
    </div>

    <div id="deck-canvas"></div>
    <div id="controls">
      <label>Plane:</label>
      <span id="planeValue">0</span>
      <input id="planeSlider" type="range" min="0" max="0" step="1" value="0" />
    </div>
    <div id="tooltip"></div>
  </div>

  <!-- external glyph scripts -->
  <script src="glyphPaths.js"></script>
  <script src="glyphConfig.js"></script>
  <!-- libraries -->
  <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
  <script src="https://unpkg.com/d3-dsv@3"></script>
  <script src="https://unpkg.com/d3-array@3"></script>

  <script>
    const DATA_URL = 'data/geneData.tsv';

    const settings = glyphSettings();
    const configMap = new Map(settings.map(s => [s.gene, {glyphName:s.glyphName, color:s.color}]));
    const defaultConfig = configMap.get('Generic') || {glyphName:'circle', color:'#ffffff'};

    let data = [];
    let filteredData = [];
    let genes = [];
    let plane = 0;
    let iconAtlas = null;
    let iconMapping = null;
    let visibleGenes = new Set();

    function buildAtlas(list) {
      const size=64;
      const canvas=document.createElement('canvas');
      canvas.width=size*list.length;
      canvas.height=size;
      const ctx=canvas.getContext('2d');
      const mapping={};
      list.forEach((gene, i) => {
        const cfg = configMap.get(gene) || defaultConfig;
        const p = {x: i * size + size / 2, y: size / 2};
        const r = size * 0.4;
        ctx.save();
        ctx.strokeStyle = cfg.color;
        ctx.lineWidth = 2;
        ctxPath(cfg.glyphName, ctx, p, r);
        ctx.stroke();
        ctx.restore();
        mapping[gene] = {x: i * size, y: 0, width: size, height: size};
      });
      return {atlas: canvas, mapping};
    }

    const {IconLayer, OrthographicView, COORDINATE_SYSTEM} = deck;
    let deckgl; // Defined here to be in scope

    const tooltip = document.getElementById('tooltip');
    // Remove all cursor logic from onHover. Its only job is the tooltip.
    function onHover({x, y, object}){
      if (object) {
        tooltip.style.display = 'block';
        tooltip.style.left = x + 220 + 5 + 'px';
        tooltip.style.top = y + 5 + 'px';
        tooltip.innerHTML =
          `<strong>Gene:</strong> ${object.gene}<br>`+
          `<strong>Coords:</strong> ${object.x.toFixed(2)}, ${object.y.toFixed(2)}<br>`+
          `<strong>Plane:</strong> ${object.z}`;
      } else {
        tooltip.style.display = 'none';
      }
    }

    function updateLayer() {
      deckgl.setProps({layers: [
        new IconLayer({
          id: 'spots',
          // The layer now gets its data from our new `filteredData` array.
          data: filteredData,
          pickable: true,
          onHover,
          coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
          iconAtlas,
          iconMapping,
          getPosition: d => [d.x, -d.y],
          // The size accessor is now simple and fast again. No more `.has()` check.
          getSize: d => 20 / Math.sqrt(1 + Math.abs(d.z - plane)),
          getIcon: d => d.gene,
          getColor: [255, 255, 255],
          sizeUnits: 'pixels',
          sizeScale: 1,
          updateTriggers: {
            // The trigger for `getSize` no longer needs `visibleGenes`.
            getSize: [plane]
          }
        })
      ]});
    }

    // A new helper function to do the slow filtering and then re-render.
    function applyGeneFilterAndRender() {
      filteredData = data.filter(d => visibleGenes.has(d.gene));
      updateLayer();
    }

    // Function to dynamically create the filter checkboxes
    function createGeneFilters(geneList) {
      const container = document.getElementById('filter-list');
      container.innerHTML = ''; // Clear previous filters

      // Sort genes alphabetically for a clean list
      geneList.sort();

      for (const gene of geneList) {
        const item = document.createElement('label');
        item.className = 'filter-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true; // Start with all genes visible

        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        const cfg = configMap.get(gene) || defaultConfig;
        swatch.style.backgroundColor = cfg.color;

        const name = document.createElement('span');
        name.textContent = gene;

        item.appendChild(checkbox);
        item.appendChild(swatch);
        item.appendChild(name);
        container.appendChild(item);

        // Add an event listener to update the visible set and re-render
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            visibleGenes.add(gene);
          } else {
            visibleGenes.delete(gene);
          }
          // Instead of just updating the layer, we now call our new filter function.
          applyGeneFilterAndRender();
        });
      }
    }

    document.getElementById('planeSlider').addEventListener('input', e => {
      plane = Number(e.target.value);
      document.getElementById('planeValue').textContent = plane;
      updateLayer();
    });

    async function run() {
      try {
        const response = await fetch(DATA_URL);
        const txt = await response.text();

        data = d3.tsvParse(txt, d => ({
          x: +d.x, y: +d.y, z: +d.plane_id, gene: d.gene_name
        }));
        // When data loads, initialize filteredData to be the same as the full data set.
        filteredData = data;

        genes = Array.from(new Set(data.map(d => d.gene)));
        // Initially, all genes are visible.
        visibleGenes = new Set(genes);

        const zExt = d3.extent(data, d => d.z);
        const slider = document.getElementById('planeSlider');
        slider.min = zExt[0]; slider.max = zExt[1];
        plane = slider.value = zExt[0];
        document.getElementById('planeValue').textContent = plane;

        const atlasInfo = buildAtlas(genes);
        iconAtlas = atlasInfo.atlas;
        iconMapping = atlasInfo.mapping;

        // Create the filter UI
        createGeneFilters(genes);

        const xExt = d3.extent(data, d => d.x);
        const yExt = d3.extent(data, d => d.y);
        const centerX = (xExt[0] + xExt[1]) / 2;
        const centerY = -(yExt[0] + yExt[1]) / 2;
        const canvas = deckgl.canvas;
        const zoom = Math.log2(Math.min(
            canvas.clientWidth / (xExt[1] - xExt[0]),
            canvas.clientHeight / (yExt[1] - yExt[0])
        ));

        deckgl.setProps({
            initialViewState: {target: [centerX, centerY, 0], zoom, minZoom: -5, maxZoom: 10}
        });

        updateLayer();
      } catch (error) {
        console.error('Failed to load or process data:', error);
      }
    }

    deckgl = new deck.Deck({
      parent: document.getElementById('deck-canvas'),
      views: new OrthographicView({controller:true}),
      initialViewState: {target: [0,0,0], zoom: 0, minZoom: -5, maxZoom: 10},
      layers: [],
      // getCursor callback to take full control of the cursor.
      getCursor: ({isHovering}) => (isHovering ? 'pointer' : 'default'),
      onLoad: run
    });

  </script>
</body>
</html>