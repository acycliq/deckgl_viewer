<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>deck.gl Gene TSV viewer</title>
  <style>
    html, body {
      margin:0;
      height:100%;
      font-family: Arial,Helvetica,sans-serif;
    }
    #root {
      position: relative;
      width:100%;
      height:100%;
      background-color: #000;
      color: #fff;
    }
    #deck-canvas {
      position:absolute;
      top:0;
      left:220px;
      right:0;
      bottom:48px;
      background-color: #000;
      cursor: default;
    }
    #controls {
      position:absolute;
      left:220px;
      right:0;
      bottom:0;
      height:48px;
      display:flex;
      align-items:center;
      padding:4px 8px;
      background:rgba(0,0,0,0.8);
      border-top:1px solid #444;
      gap:8px;
    }
    #controls label, #controls span {
      color:#fff;
    }
    input[type=range] {
      flex:1;
      background:transparent;
    }
    #tooltip {
      position:absolute;
      pointer-events:none;
      background:rgba(0,0,0,0.75);
      color:#fff;
      padding:6px;
      border-radius:4px;
      font-size:12px;
      display:none;
      white-space:nowrap;
      z-index:1000;
    }
    #filter-panel {
      position:absolute;
      top:0;
      left:0;
      bottom:0;
      width:220px;
      background: #181818;
      color: #fff;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    #filter-panel h3 {
      margin: 0;
      padding: 12px;
      font-size: 16px;
      border-bottom: 1px solid #444;
    }
    #filter-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .filter-item {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .filter-item:hover {
      background: #333;
    }
    .filter-item input {
      margin-right: 8px;
    }
    .color-swatch {
      width: 12px;
      height: 12px;
      margin-right: 8px;
      border: 1px solid #666;
    }
    .filter-toggle-all {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      border-bottom: 1px solid #444;
    }
    .filter-toggle-all input {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="root">
    <div id="filter-panel">
      <h3>Genes</h3>
      <div class="filter-toggle-all">
        <input id="toggleAll" type="checkbox" checked />
        <label for="toggleAll">Show all</label>
      </div>
      <div id="filter-list"></div>
    </div>

    <div id="deck-canvas"></div>
    <div id="controls">
      <label>Plane:</label>
      <span id="planeValue">0</span>
      <input id="planeSlider" type="range" min="0" max="0" step="1" value="0" />
    </div>
    <div id="tooltip"></div>
  </div>

  <script src="glyphPaths.js"></script>
  <script src="glyphConfig.js"></script>
  <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
  <script src="https://unpkg.com/d3-dsv@3"></script>
  <script src="https://unpkg.com/d3-array@3"></script>

  <script>
    const DATA_URL = 'data/geneData.tsv';

    const settings = glyphSettings();
    const configMap = new Map(settings.map(s => [s.gene, {glyphName:s.glyphName, color:s.color}]));
    const defaultConfig = configMap.get('Generic') || {glyphName:'circle', color:'#ffffff'};

    let data = [];
    const geneDataMap = new Map();
    const visibilityMap = new Map();
    const geneCheckboxElems = [];

    let iconAtlas = null;
    let iconMapping = null;
    let deckgl;
    let plane = 0;

    const {IconLayer, OrthographicView, COORDINATE_SYSTEM} = deck;
    const tooltip = document.getElementById('tooltip');

    function onHover({x, y, object}){
      if (object) {
        tooltip.style.display = 'block';
        tooltip.style.left = x + 220 + 5 + 'px';
        tooltip.style.top = y + 5 + 'px';
        tooltip.innerHTML =
          `<strong>Gene:</strong> ${object.gene}<br>`+
          `<strong>Coords:</strong> ${object.x.toFixed(2)}, ${object.y.toFixed(2)}<br>`+
          `<strong>Plane:</strong> ${object.z}`;
      } else {
        tooltip.style.display = 'none';
      }
    }

    function buildAtlas(list) {
      const size=64;
      const canvas=document.createElement('canvas');
      canvas.width=size*list.length;
      canvas.height=size;
      const ctx=canvas.getContext('2d');
      const mapping={};
      list.forEach((gene, i) => {
        const cfg = configMap.get(gene) || defaultConfig;
        const p = {x: i * size + size / 2, y: size / 2};
        const r = size * 0.4;
        ctx.save();
        ctx.strokeStyle = cfg.color;
        ctx.lineWidth = 2;
        ctxPath(cfg.glyphName, ctx, p, r);
        ctx.stroke();
        ctx.restore();
        mapping[gene] = {x: i * size, y: 0, width: size, height: size};
      });
      return {atlas: canvas, mapping};
    }

    function makeLayer(gene){
      return new IconLayer({
        id: gene,
        data: geneDataMap.get(gene),
        visible: visibilityMap.get(gene),
        pickable: true,
        onHover,
        coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
        iconAtlas,
        iconMapping,
        getPosition: d => [d.x, -d.y],
        getSize: d => 20 / Math.sqrt(1 + Math.abs(d.z - plane)),
        getIcon: d => d.gene,
        getColor: [255,255,255],
        sizeUnits: 'pixels',
        sizeScale: 1,
        updateTriggers: {getSize:[plane]}
      });
    }

    function updateLayers(){
      const layers = [];
      for(const gene of geneDataMap.keys()){
        layers.push(makeLayer(gene));
      }
      deckgl.setProps({layers});
    }

    function syncMasterToggle() {
      const checkedStates = geneCheckboxElems.map(cb => cb.checked);
      const allChecked = checkedStates.every(Boolean);
      const noneChecked = checkedStates.every(checked => !checked);
      const toggleAll = document.getElementById('toggleAll');
      toggleAll.checked = allChecked;
      toggleAll.indeterminate = !allChecked && !noneChecked;
    }

    function createGeneFilters(geneList) {
      const container = document.getElementById('filter-list');
      container.innerHTML = '';
      geneList.sort();
      geneCheckboxElems.length = 0;

      for (const gene of geneList) {
        visibilityMap.set(gene, true);
        const item = document.createElement('label');
        item.className = 'filter-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        geneCheckboxElems.push(checkbox);

        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        const cfg = configMap.get(gene) || defaultConfig;
        swatch.style.backgroundColor = cfg.color;

        const name = document.createElement('span');
        name.textContent = gene;

        item.appendChild(checkbox);
        item.appendChild(swatch);
        item.appendChild(name);
        container.appendChild(item);

        checkbox.addEventListener('change', (e) => {
          visibilityMap.set(gene, e.target.checked);
          syncMasterToggle();
          updateLayers();
        });
      }
    }

    document.getElementById('planeSlider').addEventListener('input', e => {
      plane = Number(e.target.value);
      document.getElementById('planeValue').textContent = plane;
      updateLayers();
    });

    async function run(){
      try {
        const response = await fetch(DATA_URL);
        const txt = await response.text();

        data = d3.tsvParse(txt, d => ({
          x: +d.x, y: +d.y, z: +d.plane_id, gene: d.gene_name
        }));

        for(const d of data){
          if(!geneDataMap.has(d.gene)) geneDataMap.set(d.gene, []);
          geneDataMap.get(d.gene).push(d);
        }

        const genes = [...geneDataMap.keys()];

        const zExt = d3.extent(data, d => d.z);
        const slider = document.getElementById('planeSlider');
        slider.min = zExt[0];
        slider.max = zExt[1];
        plane = slider.value = zExt[0];
        document.getElementById('planeValue').textContent = plane;

        const atlasInfo = buildAtlas(genes);
        iconAtlas = atlasInfo.atlas;
        iconMapping = atlasInfo.mapping;

        createGeneFilters(genes);

        document.getElementById('toggleAll').addEventListener('change', e => {
          const newState = e.target.checked;
          genes.forEach((gene, i) => {
            visibilityMap.set(gene, newState);
            geneCheckboxElems[i].checked = newState;
          });
          e.target.indeterminate = false;
          updateLayers();
        });

        const xExt = d3.extent(data, d => d.x);
        const yExt = d3.extent(data, d => d.y);
        const centerX = (xExt[0] + xExt[1]) / 2;
        const centerY = -(yExt[0] + yExt[1]) / 2;
        const canvas = deckgl.canvas;
        const zoom = Math.log2(Math.min(
            canvas.clientWidth / (xExt[1] - xExt[0]),
            canvas.clientHeight / (yExt[1] - yExt[0])
        ));

        deckgl.setProps({
            initialViewState: {target: [centerX, centerY, 0], zoom, minZoom: -5, maxZoom: 10}
        });

        updateLayers();
        syncMasterToggle();
      } catch (error) {
        console.error('Failed to load or process data:', error);
      }
    }

    deckgl = new deck.Deck({
      parent: document.getElementById('deck-canvas'),
      views: new OrthographicView({controller:true}),
      initialViewState: {target: [0,0,0], zoom: 0, minZoom: -5, maxZoom: 10},
      layers: [],
      getCursor: ({isHovering}) => (isHovering ? 'pointer' : 'default'),
      onLoad: run
    });
  </script>
</body>
</html>
