<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>deck.gl Gene TSV viewer</title>
  <style>
    html, body {
      margin:0;
      height:100%;
      font-family: Arial,Helvetica,sans-serif;
    }
    #root {
      position: relative;
      width:100%;
      height:100%;
      background-color: #000;
    }
    #deck-canvas {
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:48px;
    }
    #controls {
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:48px;
      display:flex;
      align-items:center;
      padding:4px 8px;
      background:#fafafa;
      border-top:1px solid #ccc;
      box-shadow:0 -2px 4px rgba(0,0,0,0.1);
      gap:8px;
    }
    #planeValue {
      width:48px;
      text-align:right;
    }
    input[type=range] {
      flex:1;
    }
  </style>
</head>
<body>
  <div id="root">
    <div id="deck-canvas"></div>
    <div id="controls">
      <label>Plane:</label>
      <span id="planeValue">0</span>
      <input id="planeSlider" type="range" min="0" max="0" step="1" value="0" />
    </div>
  </div>

  <!-- external glyph scripts -->
  <script src="glyphPaths.js"></script>
  <script src="glyphConfig.js"></script>
  <!-- libraries -->
  <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
  <script src="https://unpkg.com/d3-dsv@3"></script>
  <script src="https://unpkg.com/d3-array@3"></script>

  <script>
    // Load config: gene -> glyphName & color hex
    const settings = glyphSettings();
    const configMap = new Map(settings.map(s => [s.gene, {glyphName: s.glyphName, color: s.color}]));
    const defaultConfig = configMap.get('Generic') || {glyphName:'circle', color:'#000000'};

    function hexToRgba(hex) {
      const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      return m ? [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)] : [0,0,0];
    }

    // Build atlas for each gene_name, drawing colored glyph
    function buildAtlas(genes){
      const size = 64;
      const canvas = document.createElement('canvas');
      canvas.width = size * genes.length;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      const mapping = {};

      genes.forEach((gene, i) => {
        const cfg = configMap.get(gene) || defaultConfig;
        const glyphName = cfg.glyphName;
        const color = cfg.color;
        const rgb = hexToRgba(color);
        const p = {x: i*size + size/2, y: size/2};
        const r = size * 0.4;
        ctx.save();
        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        // draw shape
        ctxPath(glyphName, ctx, p, r);
        ctx.stroke();
        // ctx.fill();
        ctx.restore();

        mapping[gene] = {x: i*size, y: 0, width: size, height: size, anchorX: size/2, anchorY: size/2, mask: false};
      });

      return {atlas: canvas, mapping};
    }

    const {IconLayer, OrthographicView, COORDINATE_SYSTEM} = deck;
    let data = [], plane = 0, iconAtlas = null, iconMapping = null;

    const deckgl = new deck.Deck({
      parent: document.getElementById('deck-canvas'),
      views: new OrthographicView({controller:true}),
      initialViewState:{target:[0,0,0], zoom:0, minZoom:-5, maxZoom:10},
      controller:true,
      layers: []
    });

    function makeLayer(){
      return new IconLayer({
        id: 'spots',
        data,
        coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
        iconAtlas,
        iconMapping,
        getPosition: d => [d.x, -d.y],
        getSize: d => 20 / Math.sqrt(1 + Math.abs(d.z - plane)),
        sizeUnits: 'pixels',
        sizeScale: 1,
        getIcon: d => d.gene,
        // icons already colored in atlas, so tint white
        getColor: [255,255,255],
        updateTriggers: {getSize: [plane]}
      });
    }

    function updateLayers(){ if(iconAtlas) deckgl.setProps({layers:[makeLayer()]}); }

    const slider = document.getElementById('planeSlider');
    const planeLabel = document.getElementById('planeValue');
    slider.addEventListener('input', e => { plane = +e.target.value; planeLabel.textContent = plane; updateLayers(); });

    // Load TSV
    fetch('data/geneData.tsv')
      .then(r => r.text())
      .then(txt => {
        data = d3.tsvParse(txt, d => ({
          x: +d.x,
          y: +d.y,
          z: +d.plane_id,
          gene: d.gene_name
        }));

        // setup slider
        const zExt = d3.extent(data, d => d.z);
        slider.min = zExt[0]; slider.max = zExt[1]; slider.step = 1;
        plane = slider.value = zExt[0]; planeLabel.textContent = plane;

        // build atlas per gene
        const genes = Array.from(new Set(data.map(d => d.gene)));
        const atlasObj = buildAtlas(genes);
        iconAtlas = atlasObj.atlas;
        iconMapping = atlasObj.mapping;

        // fit view
        const xExt = d3.extent(data, d => d.x);
        const yExt = d3.extent(data, d => d.y);
        const cx = (xExt[0] + xExt[1]) / 2;
        const cy = -(yExt[0] + yExt[1]) / 2;
        const w = deckgl.canvas.clientWidth;
        const h = deckgl.canvas.clientHeight;
        const zoom = Math.min(Math.log2(w / (xExt[1] - xExt[0])), Math.log2(h / (yExt[1] - yExt[0])));
        deckgl.setProps({initialViewState: {target:[cx, cy, 0], zoom, minZoom:-5, maxZoom:10}});

        updateLayers();
      })
      .catch(e => console.error('Load error', e));
  </script>
</body>
</html>
