<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>deck.gl Gene TSV viewer</title>
  <style>
    html, body {
      margin:0;
      height:100%;
      font-family: Arial,Helvetica,sans-serif;
    }
    #root {
      position: relative;
      width:100%;
      height:100%;
      background-color: #000;
      color: #fff;
    }
    #deck-canvas {
      position:absolute;
      top:0;
      left:220px;
      right:0;
      bottom:48px;
      background-color: #000;
      cursor: default;
    }
    #controls {
      position:absolute;
      left:220px;
      right:0;
      bottom:0;
      height:48px;
      display:flex;
      align-items:center;
      padding:4px 8px;
      background:rgba(0,0,0,0.8);
      border-top:1px solid #444;
      gap:8px;
    }
    #controls label, #controls span {
      color:#fff;
    }
    input[type=range] {
      flex:1;
      background:transparent;
    }
    #tooltip {
      position:absolute;
      pointer-events:none;
      background:rgba(0,0,0,0.75);
      color:#fff;
      padding:6px;
      border-radius:4px;
      font-size:12px;
      display:none;
      white-space:nowrap;
      z-index:1000;
    }
    #filter-panel {
      position:absolute;
      top:0;
      left:0;
      bottom:0;
      width:220px;
      background: #181818;
      color: #fff;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    #filter-panel h3 {
      margin: 0;
      padding: 12px;
      font-size: 16px;
      border-bottom: 1px solid #444;
    }
    #filter-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .filter-item {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .filter-item:hover {
      background: #333;
    }
    .filter-item input {
      margin-right: 8px;
    }
    .color-swatch {
      width: 12px;
      height: 12px;
      margin-right: 8px;
      border: 1px solid #666;
    }
    .filter-toggle-all {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      border-bottom: 1px solid #444;
    }
    .filter-toggle-all input {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="root">
    <div id="filter-panel">
      <h3>Genes</h3>
      <!-- master checkbox -->
      <div class="filter-toggle-all">
        <input id="toggleAll" type="checkbox" />
        <label id="toggleAllLabel" for="toggleAll">Hide all</label>

        <label>Size:</label>
        <span id="sizeValue">1</span>
        <input id="sizeSlider" type="range" min="0.5" max="3" step="0.1" value="1" />

      </div>
      <div id="filter-list"></div>
    </div>

    <div id="deck-canvas"></div>
    <div id="controls">
      <label>Plane:</label>
      <span id="planeValue">0</span>
      <input id="planeSlider" type="range" min="0" max="0" step="1" value="0" />
    </div>
    <div id="tooltip"></div>
  </div>

  <!-- helper scripts -->
  <script src="glyphPaths.js"></script>
  <script src="glyphConfig.js"></script>
  <!-- libs -->
  <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
  <script src="https://unpkg.com/d3-dsv@3"></script>
  <script src="https://unpkg.com/d3-array@3"></script>

  <script>
    /* === DATA / SETTINGS === */
    const DATA_URL = 'data/geneData.tsv';
    const settings = glyphSettings();
    const configMap = new Map(settings.map(s => [s.gene, {glyphName:s.glyphName, color:s.color}]));
    const defaultConfig = configMap.get('Generic') || {glyphName:'circle', color:'#ffffff'};

    /* === STATE === */
    const geneDataMap = new Map();      // gene -> spots[]
    const geneCheckboxMap = new Map();  // gene -> <input>
    const geneCheckboxElems = [];       // array for master sync

    let iconAtlas = null;
    let iconMapping = null;
    let deckgl;
    let plane = 0;

    let sizeScale = 1;

    const {IconLayer, OrthographicView, COORDINATE_SYSTEM} = deck;
    const tooltip = document.getElementById('tooltip');

    /* === UI HELPERS === */
    function onHover({x, y, object}){
      if (object) {
        tooltip.style.display = 'block';
        tooltip.style.left = x + 225 + 'px';
        tooltip.style.top  = y + 5 + 'px';
        tooltip.innerHTML  = `<strong>Gene:</strong> ${object.gene}<br>`+
                             `<strong>Coords:</strong> ${object.x.toFixed(2)}, ${object.y.toFixed(2)}<br>`+
                             `<strong>Plane:</strong> ${object.z}`;
      } else {
        tooltip.style.display = 'none';
      }
    }

    function buildAtlas(genes){
      const size=64;
      const canvas=document.createElement('canvas');
      canvas.width=size*genes.length;
      canvas.height=size;
      const ctx=canvas.getContext('2d');
      const mapping={};
      genes.forEach((gene,i)=>{
        const cfg=configMap.get(gene)||defaultConfig;
        const p={x:i*size+size/2,y:size/2};
        const r=size*0.4;
        ctx.save();

        // // Outline: white, thicker
        // ctx.strokeStyle = '#ffffff';
        // ctx.lineWidth = 6;
        // ctxPath(cfg.glyphName, ctx, p, r);
        // ctx.stroke();

        // Actual colour stroke
        ctx.strokeStyle=cfg.color;
        ctx.lineWidth=4;
        ctxPath(cfg.glyphName,ctx,p,r);
        ctx.stroke();

        ctx.restore();
        mapping[gene]={x:i*size,y:0,width:size,height:size};
      });
      return {atlas:canvas,mapping};
    }

    /* === LAYER CREATION === */
    function makeLayer(gene){
      return new IconLayer({
        id:gene,
        data:geneDataMap.get(gene),
        visible: geneCheckboxMap.get(gene)?.checked ?? true,
        pickable:true,
        onHover,
        coordinateSystem:COORDINATE_SYSTEM.CARTESIAN,
        iconAtlas,
        iconMapping,
        getPosition:d=>[d.x,-d.y],
        getSize:d=>(20 * sizeScale)/Math.sqrt(1+Math.abs(d.z-plane)),
        getIcon:d=>d.gene,
        getColor:[255,255,255],
        sizeUnits:'pixels',
        sizeScale: 1,
        updateTriggers:{getSize:[plane, sizeScale]}
      });
    }

    function updateLayers(){
      const layers=[];
      for(const gene of geneDataMap.keys()) layers.push(makeLayer(gene));
      deckgl.setProps({layers});
    }

    /* === FILTER PANEL === */
    function syncMasterToggle(){
      const states = geneCheckboxElems.map(cb => cb.checked);
      const all  = states.every(Boolean);
      const none = states.every(v=>!v);
      const master=document.getElementById('toggleAll');
      const label = document.getElementById('toggleAllLabel');

      if(all){
        master.checked=false;            // ready to hide all
        master.indeterminate=false;
        label.textContent='Hide all';
      }else if(none){
        master.checked=true;             // ready to show all
        master.indeterminate=false;
        label.textContent='Show all';
      }else{
        master.indeterminate=true;       // mixed
        label.textContent='Show all';
      }
    }

    function createGeneFilters(genes){
      const container=document.getElementById('filter-list');
      container.innerHTML='';
      genes.sort();
      geneCheckboxElems.length=0;
      genes.forEach(gene=>{
        const item=document.createElement('label');
        item.className='filter-item';
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.checked=true;
        geneCheckboxMap.set(gene,cb);
        geneCheckboxElems.push(cb);
        const swatch=document.createElement('div');
        swatch.className='color-swatch';
        const cfg=configMap.get(gene)||defaultConfig;
        swatch.style.backgroundColor=cfg.color;
        const name=document.createElement('span');
        name.textContent=gene;
        item.append(cb,swatch,name);
        container.appendChild(item);
        cb.addEventListener('change',()=>{syncMasterToggle();updateLayers();});
      });
    }

    /* === MAIN === */
    document.getElementById('planeSlider').addEventListener('input',e=>{
      plane=+e.target.value;
      document.getElementById('planeValue').textContent=plane;
      updateLayers();
    });

    document.getElementById('sizeSlider')
            .addEventListener('input', e => {
            sizeScale = +e.target.value;
            document.getElementById('sizeValue').textContent = sizeScale;
            updateLayers();
            });

    document.getElementById('toggleAll').addEventListener('change',e=>{
      const hide=e.target.checked; // true -> hide all
      geneCheckboxElems.forEach(cb=>cb.checked=!hide);
      e.target.indeterminate=false;
      document.getElementById('toggleAllLabel').textContent=hide?'Show all':'Hide all';
      updateLayers();
    });

    async function run(){
      try{
        const txt=await (await fetch(DATA_URL)).text();
        const data=d3.tsvParse(txt,d=>({x:+d.x,y:+d.y,z:+d.plane_id,gene:d.gene_name}));
        data.forEach(d=>{if(!geneDataMap.has(d.gene))geneDataMap.set(d.gene,[]);geneDataMap.get(d.gene).push(d);});

        const genes=[...geneDataMap.keys()];
        const {atlas,mapping}=buildAtlas(genes);
        iconAtlas=atlas;iconMapping=mapping;
        createGeneFilters(genes);

        const zExt=d3.extent(data,d=>d.z);
        const slider=document.getElementById('planeSlider');
        slider.min=zExt[0];slider.max=zExt[1];plane=slider.value=zExt[0];
        document.getElementById('planeValue').textContent=plane;

        const xExt=d3.extent(data,d=>d.x);
        const yExt=d3.extent(data,d=>d.y);
        const centerX=(xExt[0]+xExt[1])/2;
        const centerY=-(yExt[0]+yExt[1])/2;
        const canvas=deckgl.canvas;
        const zoom=Math.log2(Math.min(canvas.clientWidth/(xExt[1]-xExt[0]),canvas.clientHeight/(yExt[1]-yExt[0])));
        deckgl.setProps({initialViewState:{target:[centerX,centerY,0],zoom,minZoom:-5,maxZoom:10}});

        updateLayers();
        syncMasterToggle();
      }catch(err){console.error('Failed to load or process data:',err);}
    }

    deckgl=new deck.Deck({
      parent:document.getElementById('deck-canvas'),
      views:new OrthographicView({controller:true}),
      initialViewState:{target:[0,0,0],zoom:0,minZoom:-5,maxZoom:10},
      layers:[],
      getCursor:({isHovering})=>(isHovering?'pointer':'default'),
      onLoad:run
    });
  </script>
</body>
</html>
